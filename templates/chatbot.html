{% extends "base.html" %}

{% block title %}AI Assistant - P2P Workflow{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>ðŸ¤– P2P Workflow Assistant</h1>
    <a href="/chatbot/settings" class="btn btn-outline-primary">
        <i class="bi bi-gear"></i> Settings
    </a>
</div>

<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div class="card-header">Chat with the Assistant</div>
    
    <div id="chat-container" style="height: 500px; overflow-y: auto; padding: 1rem; background-color: #f8f9fa; border-radius: 4px; margin-bottom: 1rem;">
        <div class="chat-message bot-message">
            <div class="message-content">
                <strong>ðŸ¤– Assistant:</strong><br>
                Hello! I'm your P2P Workflow Assistant. I can help you with:
                <ul style="margin-top: 0.5rem;">
                    <li>View statistics and summaries</li>
                    <li>Check pending approvals</li>
                    <li>Find purchase orders, goods receipts, or invoices</li>
                    <li>Explain the P2P process</li>
                    <li>Check blocked documents</li>
                </ul>
                Just ask me anything about the procurement process! Try "help" to see what I can do.
            </div>
        </div>
    </div>
    
    <form id="chat-form" style="display: flex; gap: 0.5rem;">
        <input type="text" id="user-input" class="form-control" placeholder="Type your question here..." style="flex: 1;" autofocus>
        <button type="submit" class="btn btn-primary">Send</button>
    </form>
    
    <div style="margin-top: 1rem; padding: 1rem; background-color: #e7f3ff; border-radius: 4px;">
        <strong>ðŸ’¡ Try asking:</strong>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="btn btn-sm btn-outline-primary suggestion-btn" data-text="Show statistics">Show statistics</button>
            <button class="btn btn-sm btn-outline-primary suggestion-btn" data-text="What's pending approval?">Pending approvals</button>
            <button class="btn btn-sm btn-outline-primary suggestion-btn" data-text="Explain P2P process">Explain P2P</button>
            <button class="btn btn-sm btn-outline-primary suggestion-btn" data-text="Show blocked documents">Blocked docs</button>
            <button class="btn btn-sm btn-outline-primary suggestion-btn" data-text="Total spend">Total spend</button>
        </div>
    </div>
</div>

<style>
.chat-message {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 8px;
    max-width: 80%;
}

.user-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.bot-message {
    background-color: white;
    border: 1px solid #dee2e6;
}

.message-content {
    word-wrap: break-word;
}

.form-control {
    padding: 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.suggestion-btn {
    font-size: 0.875rem;
}
</style>

<script>
const chatContainer = document.getElementById('chat-container');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');

// Auto-scroll to bottom
function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Add message to chat
function addMessage(text, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'}`;
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (isUser) {
        contentDiv.innerHTML = `<strong>You:</strong><br>${escapeHtml(text)}`;
    } else {
        // Check if response contains HTML (check for any HTML tag)
        if (text.trim().startsWith('<')) {
            // Render HTML directly (for visualizations)
            contentDiv.innerHTML = `<strong>ðŸ¤– Assistant:</strong><br>${text}`;
            // Execute any scripts in the HTML
            setTimeout(() => {
                const scripts = contentDiv.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    newScript.textContent = script.textContent;
                    document.body.appendChild(newScript);
                    document.body.removeChild(newScript);
                });
            }, 100);
        } else {
            // Convert markdown-style formatting to HTML
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\n/g, '<br>'); // Line breaks
            contentDiv.innerHTML = `<strong>ðŸ¤– Assistant:</strong><br>${formattedText}`;
        }
    }
    
    messageDiv.appendChild(contentDiv);
    chatContainer.appendChild(messageDiv);
    scrollToBottom();
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Handle form submission
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const message = userInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage(message, true);
    userInput.value = '';
    
    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message bot-message';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = '<div class="message-content">ðŸ¤– Typing...</div>';
    chatContainer.appendChild(typingDiv);
    scrollToBottom();
    
    try {
        // Send to server
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // Remove typing indicator
        document.getElementById('typing-indicator').remove();
        
        // Add bot response
        addMessage(data.response);
        
    } catch (error) {
        document.getElementById('typing-indicator').remove();
        addMessage('Sorry, I encountered an error. Please try again.');
        console.error('Error:', error);
    }
});

// Handle suggestion button clicks
document.querySelectorAll('.suggestion-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        userInput.value = btn.getAttribute('data-text');
        userInput.focus();
    });
});

// Initial scroll
scrollToBottom();
</script>
{% endblock %}
